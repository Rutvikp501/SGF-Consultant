
{
    UF_CRM_1725626932463: "",//consultant_code
    UF_CRM_1725958005830: "",//consultant_mobile_no
    UF_CRM_1725957892961: "",//consultant_email_id
    name: "",//event name
    email: "",//email
    phone: "",//phone
    UF_CRM_1723871068885: "",//event_location
    UF_CRM_1725958658829: "",//lead_id
    UF_CRM_1723870992344: "",// Date of issue
    UF_CRM_1723871015696: "",// Booking Name  
    UF_CRM_1723871636157: "",// Date and time of event 
    UF_CRM_1724929500047: "",// Event Type 
    UF_CRM_1726651078700: "",// Event name 
    UF_CRM_1725627014795: "",// eventDate 
    UF_CRM_1725627051950: "",//eventSpecialsName 
    UF_CRM_1725627132023: "",//specialCode
    UF_CRM_1725961934686: "",// Package amount
    UF_CRM_1723870968846: "",// Equiry No
    UF_CRM_1723872311251: "",// City
    UF_CRM_1726651303165: "",// Pincode
}

//   let params = {
//     consultant: '66ab659fdec07a2c29fd9609',
//     name: 'Rutvik',
//     email: 'test1@gmail.com',
//     phone: '12341234',
//     pincode: '421102',
//     eventSpecialsName: 'testing',
//     specialCode: 'code123',
//     leadType: 'Regular',
//     status: 'Pending',
//     events: [
//       {
//         name: 'testing',
//         location: 'mumbai',
//         date: '2024-09-17',
//         timing: '2-5'
//       }
//     ],
//     package: {
//       packageName: 'package',
//       subname: 'subname',
//       addOns: '',
//       amount: 12345
//     }
//   }

const getdata={
    "result": {
        "ID": "82",
        "TITLE": "Lead Testing",
        "HONORIFIC": null,
        "NAME": "Lead Testing",
        "SECOND_NAME": null,
        "LAST_NAME": null,
        "COMPANY_TITLE": null,
        "COMPANY_ID": null,
        "CONTACT_ID": null,
        "IS_RETURN_CUSTOMER": "N",
        "BIRTHDATE": "",
        "SOURCE_ID": null,
        "SOURCE_DESCRIPTION": null,
        "STATUS_ID": "JUNK",
        "STATUS_DESCRIPTION": null,
        "POST": null,
        "COMMENTS": null,
        "CURRENCY_ID": "INR",
        "OPPORTUNITY": "0.00",
        "IS_MANUAL_OPPORTUNITY": "N",
        "HAS_PHONE": "Y",
        "HAS_EMAIL": "Y",
        "HAS_IMOL": "N",
        "ASSIGNED_BY_ID": "8",
        "CREATED_BY_ID": "8",
        "MODIFY_BY_ID": "1",
        "DATE_CREATE": "2024-09-10T19:33:39+03:00",
        "DATE_MODIFY": "2024-09-12T19:57:07+03:00",
        "DATE_CLOSED": "2024-09-12T00:00:00+03:00",
        "STATUS_SEMANTIC_ID": "F",
        "OPENED": "N",
        "ORIGINATOR_ID": null,
        "ORIGIN_ID": null,
        "MOVED_BY_ID": "1",
        "MOVED_TIME": "2024-09-12T19:57:07+03:00",
        "ADDRESS": null,
        "ADDRESS_2": null,
        "ADDRESS_CITY": null,
        "ADDRESS_POSTAL_CODE": null,
        "ADDRESS_REGION": null,
        "ADDRESS_PROVINCE": null,
        "ADDRESS_COUNTRY": null,
        "ADDRESS_COUNTRY_CODE": null,
        "ADDRESS_LOC_ADDR_ID": null,
        "UTM_SOURCE": null,
        "UTM_MEDIUM": null,
        "UTM_CAMPAIGN": null,
        "UTM_CONTENT": null,
        "UTM_TERM": null,
        "LAST_ACTIVITY_BY": "8",
        "LAST_ACTIVITY_TIME": "2024-09-10T19:33:39+03:00",
        "UF_CRM_1722419358464": [],
        "UF_CRM_1723870968846": "",
        "UF_CRM_1723870992344": "",
        "UF_CRM_1723871015696": "",
        "UF_CRM_1723871043438": "",
        "UF_CRM_1723871068885": "AMBIVALI",
        "UF_CRM_1723871299165": "",
        "UF_CRM_1723871321106": "",
        "UF_CRM_1723871636157": "2024-09-10T03:00:00+03:00",
        "UF_CRM_1723871684738": "",
        "UF_CRM_1723871708430": "",
        "UF_CRM_1723872311251": "",
        "UF_CRM_INSTAGRAM_WZ": "",
        "UF_CRM_VK_WZ": "",
        "UF_CRM_AVITO_WZ": "",
        "UF_CRM_TELEGRAMUSERNAME_WZ": "",
        "UF_CRM_TELEGRAMID_WZ": "",
        "UF_CRM_1724134367966": "",
        "UF_CRM_1724134440238": "",
        "UF_CRM_1724754601811": "",
        "UF_CRM_1724912062877": "",
        "UF_CRM_1724912903": false,
        "UF_CRM_1724913090": [],
        "UF_CRM_1724929500047": "Regular",
        "UF_CRM_1725626932463": "1KLY05SWAPNILJOSHI",
        "UF_CRM_1725627014795": "2024-09-10T03:00:00+03:00",
        "UF_CRM_1725627051950": "Testing",
        "UF_CRM_1725627132023": "123123",
        "UF_CRM_1725957892961": "joshi.swap999@gmail.com",
        "UF_CRM_1725958005830": "81088429546",
        "UF_CRM_1725958658829": "1KLY05SWAPNILJOSHI-RE1L2Y24",
        "UF_CRM_1725961934686": "123123",
        "UF_CRM_1726161691803": false,
        "UF_CRM_1726161815933": false,
        "UF_CRM_1726162680849": "",
        "UF_CRM_1726651078700": false,
        "UF_CRM_1726651303165": "",
        "UF_CRM_1726770095504": "",
        "PHONE": [
            {
                "ID": "166",
                "VALUE_TYPE": "WORK",
                "VALUE": "8591575654",
                "TYPE_ID": "PHONE"
            }
        ],
        "EMAIL": [
            {
                "ID": "168",
                "VALUE_TYPE": "WORK",
                "VALUE": "rutvik72patil@gmail.com",
                "TYPE_ID": "EMAIL"
            }
        ]
    },
    "time": {
        "start": 1729681752.2603419,
        "finish": 1729681752.3208289,
        "duration": 0.060487031936645508,
        "processing": 0.040335893630981445,
        "date_start": "2024-10-23T14:09:12+03:00",
        "date_finish": "2024-10-23T14:09:12+03:00",
        "operating_reset_at": 1729682352,
        "operating": 0
    }
}
const LeadData ={
    consultant: new ObjectId("66ab659fdec07a2c29fd9609"),
    consultant_code: '001',
    consultant_mobile_no: 1111111111,
    consultant_email_id: 'testing12@gmail.com',
    name: 'laxman',
    email: 'Laxman@gmail.com',
    phone: '8097282157',
    events: [
      {
        name: 'Birthday',
        date: 2024-09-18T00:00:00.000Z,
        location: 'ambivali',
        timing: '5 pm to 10 pm'
      }
    ],
    pincode: '421102',
    eventSpecialsName: 'Anita',
    specialCode: '1234',
    leadType: 'Regular',
    status: 'Pending',
    leadID: '001-RI11L8Y24',
    cycle: { label: 'I', number: 9, year: undefined },
    currentDate: 2024-09-18T07:19:15.742Z,
    package: { name: 'premium', subname: 'NA', addonS: [ 'test' ], amount: 0 }
  }
  const requestBody= {
    'fields[NAME]': 'laxman',
    'fields[PHONE][0][VALUE]': '8097282157',
    'fields[PHONE][0][VALUE_TYPE]': 'WORK',
    'fields[EMAIL][0][VALUE]': 'Laxman@gmail.com',
    'fields[EMAIL][0][VALUE_TYPE]': 'WORK',
    'fields[UF_CRM_1725626932463]': '001',
    'fields[UF_CRM_1725958005830]': 1111111111,
    'fields[UF_CRM_1725957892961]': 'testing12@gmail.com',
    'fields[UF_CRM_1723871068885]': 'ambivali',
    'fields[UF_CRM_1725958658829]': '001-RI11L8Y24',
    'fields[UF_CRM_1723870992344]': 2024-09-18T07:19:15.742Z,
    'fields[UF_CRM_1723871015696]': 'laxman',
    'fields[UF_CRM_1723871636157]': 2024-09-18T00:00:00.000Z,
    'fields[UF_CRM_1724929500047]': 'Regular',
    'fields[UF_CRM_1725627014795]': 2024-09-18T00:00:00.000Z,
    'fields[UF_CRM_1725627051950]': 'Anita',
    'fields[UF_CRM_1725627132023]': '1234',
    'fields[UF_CRM_1725961934686]': ''
  }

  const requestBody = {
    'fields[NAME]': LeadData.name || '',
    'fields[PHONE][0][VALUE]': LeadData.phone || '',
    'fields[PHONE][0][VALUE_TYPE]': 'WORK',
    'fields[EMAIL][0][VALUE]': LeadData.email || '',
    'fields[EMAIL][0][VALUE_TYPE]': 'WORK',
    'fields[UF_CRM_1725626932463]': LeadData.consultant_code || '', // consultant_code
    'fields[UF_CRM_1725958005830]': LeadData.consultant_mobile_no || '', // consultant_mobile_no
    'fields[UF_CRM_1725957892961]': LeadData.consultant_email_id || '', // consultant_email_id
    'fields[UF_CRM_1723871068885]': LeadData.events?.[0]?.location || '', // event_location from events array
    'fields[UF_CRM_1723872311251]': LeadData.events?.[0]?.location || '', // event_location from city
    'fields[UF_CRM_1725958658829]': LeadData.leadID || '', // leadID
    'fields[UF_CRM_1723870968846]': LeadData.leadID || '', // Equiry No
    'fields[UF_CRM_1723870992344]': LeadData.currentDate || '', // currentDate
    'fields[UF_CRM_1723871015696]': LeadData.name || '', // name (duplicate but required by the API)
    'fields[UF_CRM_1723871636157]': LeadData.events?.[0]?.date || '', // date from events array
    'fields[UF_CRM_1726651078700]': LeadData.events?.[0]?.name || '', // date from events array
    'fields[UF_CRM_1724929500047]': LeadData.leadType || '', // event_type (assuming it's mapped to leadType)
    'fields[UF_CRM_1726651303165]': LeadData.pincode || '', // event_type (assuming it's mapped to leadType)
    'fields[UF_CRM_1725627014795]': LeadData.events?.[0]?.date || '', // event_date from events array
    'fields[UF_CRM_1725627051950]': LeadData.eventSpecialsName || '', // eventSpecialsName
    'fields[UF_CRM_1725627132023]': LeadData.specialCode || '', // specialCode
    'fields[UF_CRM_1725961934686]': LeadData.package?.amount || '', // package amount
};

exports.getConvertedLead = async (req, res) => {
    try {
        let data = req.body;

        // Validate if the request body contains data
        if (!data || Object.keys(data).length === 0) {
            return res.status(400).json({
                status: false,
                message: 'Request body is missing or invalid',
            });
        }

        // Find consultant details using the consultant code
        const consultantDetails = await User.findOne({ code: data.consultant });
        if (!consultantDetails) {
            return res.status(404).json({
                success: false,
                message: 'Consultant not found',
            });
        }
        console.log(consultantDetails);

        // Calculate lead cycle and other relevant info
        consultantDetails.calculateLifetimeCycleNumber();
        const leadCycle = calculateLeadCycle(data.leadType, new Date());
        const currentYear = new Date().getFullYear();
        let leadNumber = 1;
        let cycleKey = `${currentYear}-${leadCycle.Label}`;
        let commissionPercentage = 2; // Default commission

        // First check if the lead already exists in the converted leads collection
        const { leadID } = data;
        let convertedLead = await ConvertedLeadModel.findOne({ leadID });

        if (!convertedLead) {
            // If not found in converted leads, check in pending leads
            const pendingLead = await LeadModel.findOne({ leadID });

            // Update the consultant's lead cycle details
            let totalConvertedLeadsInCycle;
            let isSeasonal = data.leadType === 'Seasonal';
            let convertedLeadsPerCycle = consultantDetails.convertedLeadsPerCycle[isSeasonal ? 'seasonal' : 'regular'];

            totalConvertedLeadsInCycle = convertedLeadsPerCycle.get(cycleKey) || 0;

            // Calculate commission percentage
            if (totalConvertedLeadsInCycle >= 1 && totalConvertedLeadsInCycle <= 3) {
                commissionPercentage = 2;
            } else if (totalConvertedLeadsInCycle >= 4 && totalConvertedLeadsInCycle <= 7) {
                commissionPercentage = 3;
            } else if (totalConvertedLeadsInCycle > 7) {
                commissionPercentage = 4;
            }

            // Add the 14-day retention logic for seasonal leads
            if (isSeasonal && leadCycle.daysIntoNewCycle <= 14) {
                let previousCycleKey = `${currentYear - 1}-${leadCycle.Label}`;
                let previousCycleLeads = convertedLeadsPerCycle.get(previousCycleKey) || 0;
                if (previousCycleLeads > 7 && totalConvertedLeadsInCycle >= 1) {
                    commissionPercentage = 4; // Retain 4% if converted 1+ leads in the first 14 days
                }
            }

            // Increment the converted lead count for this cycle
            totalConvertedLeadsInCycle++;
            convertedLeadsPerCycle.set(cycleKey, totalConvertedLeadsInCycle);

            if (!pendingLead) {
                return res.status(404).json({
                    status: false,
                    message: 'Pending lead not found',
                });
            }

            // Prepare the lead data for conversion
            const leadData = {
                consultant: pendingLead.consultant,
                consultant_code: pendingLead.consultant_code,
                leadID: pendingLead.leadID,
                name: pendingLead.name,
                email: pendingLead.email,
                phone: pendingLead.phone,
                convertedLeadCycle: {
                    label: leadCycle.Label,
                    number: leadCycle.Number,
                    year: leadCycle.Year,
                },
                events: pendingLead.events,
                pincode: pendingLead.pincode,
                eventSpecialsName: pendingLead.eventSpecialsName || '',
                specialCode: pendingLead.specialCode || '',
                leadType: pendingLead.leadType,
                packages: pendingLead.package || {},
                invoice: data.invoice || [], // Handle invoice separately below
                conversionDate: new Date(),
                commission: `${commissionPercentage}%`, // Add commission
            };

            // Ensure that the required invoice fields are present
            if (data.invoice && data.invoice.length > 0) {
                const requiredInvoiceFields = ['percentage', 'totalamount', 'paymentstatus'];
                data.invoice.forEach((inv) => {
                    requiredInvoiceFields.forEach((field) => {
                        if (!inv[field]) {
                            throw new Error(`Invoice field '${field}' is required`);
                        }
                    });
                });
            }

            // Create a new converted lead
            convertedLead = new ConvertedLeadModel(leadData);
            await convertedLead.save();

            // Remove the lead from the pending leads collection after conversion
            await LeadModel.deleteOne({ leadID });
        } else {
            // If the lead is already converted, update the invoice
            if (data.invoice && data.invoice.length > 0) {
                data.invoice.forEach(newInvoice => {
                    const existingInvoiceIndex = convertedLead.invoice.findIndex(
                        inv => inv.name === newInvoice.name || inv.number === newInvoice.number
                    );

                    if (existingInvoiceIndex > -1) {
                        // If an invoice with the same name or number exists, update it
                        convertedLead.invoice[existingInvoiceIndex] = { ...convertedLead.invoice[existingInvoiceIndex], ...newInvoice };
                    } else {
                        // If the invoice doesn't exist, add it
                        convertedLead.invoice.push(newInvoice);
                    }
                });
            }

            // Update other lead data if necessary
            await ConvertedLeadModel.findByIdAndUpdate(
                convertedLead._id,
                { $set: { invoice: convertedLead.invoice } },
                { new: true }
            );
        }

        // Save consultant details
        await consultantDetails.save();

        // Return success response with updated converted lead data
        return res.status(200).json({
            status: true,
            message: 'Converted lead updated successfully',
            data: convertedLead,
        });

    } catch (err) {
        console.error('Error in getConvertedLead:', err.message);
        if (err.message.includes('Invoice field')) {
            return res.status(400).json({
                status: false,
                error: err.message,
            });
        } else {
            return res.status(500).json({
                status: false,
                error: 'An internal server error occurred: ' + err.message,
            });
        }
    }
};

exports.getconvertedLeads = async (req, res) => {
    const authHeader = req.headers.authorization;
    const authtoken = authHeader.split(" ")[1];
    const decode = jwt.verify(authtoken, token)
    const consultantId = decode.UserId|| "66ab659fdec07a2c29fd9609";
    const leadType = req.params.leadType
    // const decode = req.query
    // const consultantId = decode.consultantId;
    try {
      
        let leadsData = [];
        
        if (leadType === "Seasonal") {
            leadsData = await ConvertedLeadModel.find({ leadType: "Seasonal", consultant: consultantId });
        } else if (leadType === "Regular") {
            leadsData = await ConvertedLeadModel.find({ leadType: "Regular", consultant: consultantId });
        } else {
            leadsData = await ConvertedLeadModel.find({ consultant: consultantId });
        }

        res.send({
            success: true,
            statusCode: 200,
            leads: leadsData,
        });

    } catch (error) {
        console.error(error);
        res.status(500).send({
            success: false,
            statusCode: 500,
            message: 'Internal server error',
        });
    }
};


{
    "consultant": "string",
    "leadID": "string",
    "invoice": [
      {
        "number": "string",
        "name": "string",
        "paymentstatus": "string",
        "totalamount": 0,
        "percentage": 0,
        "commission": 0,
        "dateofconversion": "2024-09-27"
      }
    ]
}